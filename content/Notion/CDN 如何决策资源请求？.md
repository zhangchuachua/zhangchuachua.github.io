---
title: CDN 如何决策资源请求？
description: CDN 如何决策资源请求？
tags:
- 网络
create_date: 2025-01-23 10:09
filename: how-does-cdn-work.mdx
share: true
---

首先要保证网站使用了 CDN ；这样的话用户的资源请求通过 DNS 解析，将会得到 CDN 的 IP 地址；

---
DNS 的解析过程：假设需要获取 `www.bilibili.com` 的 IP

1. 浏览器查看自己的缓存；
2. 查看本地 HOST 文件
3. 向本地 DNS 解析器发起查询请求获取域名对应的 IP 地址；这一过程是递归的
4. 本地 DNS 解析器同样检查自己的缓存
5. 本地 DNS 解析器，首先向根域名服务器发起查询请求(**通过 UDP 或 TCP 协议发送 DNS 请求报文**) com. 顶级域名服务器的 IP 地址；
    1. 不需要去获取「根域名服务器」的 IP 地址，因为「根域名服务器」的 IP 地址是固定的，被硬编码到 DNS 解析器中；
6. 获取到 TLD 的 IP 地址后，向 TLD 发起查询请求获取 bilibili.com. 权威 DNS 服务器的 IP 地址；
7. 然后在想权威 DNS 服务器发起查询请求获取 www.bilibili.com. 的 IP 地址；
8. 如果网站设置了 cName (canonical name) 那么就必须获取其 cName 的 IP 地址；比如 `www.bilibili.com` 的 cName 是 `a.w.bilicdn1.com.` ；
9. DNS 解析器再次一步一步获取 `a.w.bilicdn1.com.` 的 IP 地址； `a.w.bilicdn1.com.` 的权威 DNS 服务器一般由 CND 管理，所以此时，CDN 就会通过各种方法选择一个最佳的 IP 地址返回给用户；

---

CDN 选择最佳节点的方法：

10. 用户的地理位置；
11. 节点的健康状态
12. 网络延迟
13. 负载均衡

---

CDN 也可能使用 Anycast (任播)技术：

CDN 将会把多个节点配置为共享同一个 IP 地址；将这个 IP 地址返回给用户；当用户发起请求时；会根据路由协议和路由表自动请求到最优的节点；

路由协议的主要功能：

14. 发现网络拓扑：识别整个网络中有哪些路由器和网络子网
15. 路径选择：根据算法计算最佳路径
16. 维护路由表：自动更新路由表，使用网络拓扑的变化
17. 容错和冗余：确保在路径中断时，能够启用备用路径

路由表示例：

| 目标网络地址      | 子网掩码          | 下一跳地址       | 接口   | 度量值（表示到目标网络的成本，用于选择最佳路径，度量值越低说明成本越低） |
| ----------- | ------------- | ----------- | ---- | ------------------------------------ |
| 192.168.1.0 | 255.255.255.0 | 192.168.2.1 | eth0 | 1                                    |
| 10.0.0.0    | 255.0.0.0     | 10.0.1.1    | eth1 | 2                                    |
|             |               |             |      |                                      |

---

上面的 `a.w.bilicnd1.com.` 就是 CDN 服务器，获取到 CDN 选择的最优 IP 地址后，浏览器向这个 IP 地址发起资源请请求；

边缘节点接收到请求回去查看自己是否有缓存，如果有缓存的话就直接返回；如果没有缓存，节点需要决定如何获取改资源：

18. 直接向原始服务器发送请求获取资源
19. 某些 CDN 中，节点会先尝试从上级缓存节点获取资源；